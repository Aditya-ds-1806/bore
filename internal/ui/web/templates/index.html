<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bore Inspector</title>

    <style>
        :root {
            --bg: #0f172a;
            --muted: #6b7280;
            --panel: #ffffff;
            --accent: #2563eb;
            --radius: 10px;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Inter, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: linear-gradient(180deg, #f7fafc 0%, #fff 100%);
            color: #0f172a;
        }

        header {
            padding: 16px 24px;
            border-bottom: 1px solid #edf2f7;
            display: flex;
            align-items: center;
            gap: 12px;
            background: #fff;
        }

        header h1 {
            margin: 0;
            font-size: 18px;
        }

        header p {
            margin: 0;
            color: var(--muted);
            font-size: 13px
        }

        .container {
            display: flex;
            height: calc(100% - 68px);
            min-height: 0;
        }

        .sidebar {
            width: 38%;
            max-width: 540px;
            border-right: 1px solid #eef2f7;
            padding: 16px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #fff;
        }

        #search {
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e6edf3;
            outline: none;
            width: 100%;
            box-sizing: border-box;
        }

        .requests {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .request-item {
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 120ms, transform 80ms;
            display: flex;
            flex-direction: column;
            gap: 6px;
            border: 1px solid transparent;
        }

        .request-item:hover {
            background: #fbfdff;
            transform: translateY(-1px);
        }

        .request-item.selected {
            background: #eef6ff;
            border-color: #d4e6ff;
        }

        .summary {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .method {
            font-weight: 700;
            padding: 6px 8px;
            border-radius: 6px;
            color: #fff;
            font-size: 12px;
            min-width: 56px;
            text-align: center;
        }

        .method.GET {
            background: #16a34a;
        }

        .method.POST {
            background: #0366d6;
        }

        .method.PUT {
            background: #7c3aed;
        }

        .method.DELETE {
            background: #ef4444;
        }

        .method.PATCH {
            background: #d97706;
        }

        .method.OTHER {
            background: #6b7280;
        }

        input#search {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
        }

        .path {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
            color: #0b1220;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1
        }

        .status {
            font-weight: 700;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 12px;
            color: white;
            min-width: 64px;
            text-align: center;
        }

        /* Color by status via attribute prefix */
        .status[data-status^="2"] {
            background: #16a34a;
        }

        .status[data-status^="3"] {
            background: #2563eb;
        }

        .status[data-status^="4"] {
            background: #f97316;
        }

        .status[data-status^="5"] {
            background: #dc2626;
        }

        .status[data-status="0"] {
            background: #94a3b8;
        }

        .meta {
            font-size: 12px;
            color: var(--muted);
            display: flex;
            justify-content: space-between
        }

        .details-pane {
            flex: 1;
            overflow: auto;
            padding: 20px;
            box-sizing: border-box;
            background: linear-gradient(180deg, #fff 0%, #fbfdff 100%);
        }

        .placeholder {
            color: var(--muted);
            border: 1px dashed #e6edf3;
            padding: 28px;
            border-radius: 8px;
        }

        h2 {
            margin: 8px 0;
        }

        h3 {
            margin: 6px 0;
        }

        .section {
            margin-bottom: 18px
        }

        pre {
            background: #0b1220;
            color: #e6eef8;
            padding: 12px;
            border-radius: 6px;
            overflow: auto;
            max-height: 480px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .kv {
            display: flex;
            gap: 10px;
            font-family: monospace;
            font-size: 13px;
            margin-bottom: 6px
        }

        .kv .k {
            color: #0b1220;
            min-width: 160px
        }

        .kv .v {
            color: #374151
        }

        @media (max-width: 800px) {
            .container {
                flex-direction: column
            }

            .sidebar {
                width: 100%;
                max-width: none;
                height: 44vh
            }
        }
    </style>
</head>

<body>
    <header>
        <div style="display:flex; flex-direction:column;">
            <h1>Bore Inspector</h1>
            <p>Inspect incoming requests & responses</p>
        </div>
    </header>

    <div class="container">
        <aside class="sidebar">
            <input id="search" placeholder="Ex: method:POST status:>=400 time:>1000ms content-type:json" />
            <div id="filter-help"
                style="font-size:12px; color:#6b7280; padding:4px 0; display:flex; justify-content:space-between; align-items:center;">
                <span id="filter-error" style="color:#ef4444; display:none;"></span>
            </div>

            <ul class="requests" id="requests">
                <li style="padding:20px; text-align:center; color:#6b7280;">Loading...</li>
            </ul>
        </aside>

        <main class="details-pane">
            <div id="placeholder" class="placeholder">Select a request on the left to view full details (headers, body,
                etc.)</div>
            <div id="details" aria-live="polite"></div>
        </main>
    </div>

    <script>
        // Small client-side behavior: click items to show details, filter list
        const requestsRoot = document.getElementById('requests');
        const detailsEl = document.getElementById('details');
        const placeholder = document.getElementById('placeholder');

        // Load initial data on page load
        window.addEventListener('DOMContentLoaded', () => {
            applyFilter(''); // Load all logs initially
            startPolling(); // Start auto-refresh
        });

        function formatTs(ts) {
            if (!ts) return '—';
            return new Date(Number(ts)).toLocaleTimeString();
        }

        function formatDuration(reqTs, resTs) {
            if (!reqTs || !resTs) return '—';
            const d = resTs - reqTs;
            if (d < 0) return '—';
            if (d >= 1000) return (d / 1000).toFixed(2) + ' s';
            return d + ' ms';
        }

        function populateDetailsTimestamps(root) {
            const reqEl = root.querySelector('.req-ts-hr');
            const resEl = root.querySelector('.res-ts-hr');
            const durEl = root.querySelector('.duration-hr');
            const reqTs = reqEl && reqEl.getAttribute('data-ts');
            const resTs = resEl && resEl.getAttribute('data-ts');
            if (reqEl) reqEl.innerText = formatTs(reqTs);
            if (resEl) resEl.innerText = formatTs(resTs);
            if (durEl) durEl.innerText = formatDuration(reqTs, resTs);
        }

        // Filter input with API calls
        const search = document.getElementById('search');
        const filterError = document.getElementById('filter-error');
        let debounceTimer;
        let activeFilter = '';
        let pollingInterval;

        // Start polling for updates every 2 seconds
        function startPolling() {
            if (pollingInterval) return;
            pollingInterval = setInterval(() => {
                applyFilter(activeFilter);
            }, 2000);
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
        }

        async function applyFilter(filterQuery) {
            filterQuery = filterQuery.trim();
            activeFilter = filterQuery;

            filterError.style.display = 'none';

            try {
                const response = await fetch('/api/logs?filter=' + encodeURIComponent(filterQuery));
                const data = await response.json();

                if (data.error) {
                    // Show error
                    filterError.textContent = 'Error: ' + data.error;
                    filterError.style.display = 'block';
                    return;
                }

                // Update the list with filtered logs
                const requestsList = document.getElementById('requests');
                requestsList.innerHTML = '';

                if (data.logs && data.logs.length > 0) {
                    data.logs.forEach((log, idx) => {
                        const li = createRequestItem(log, idx);
                        requestsList.appendChild(li);
                    });
                    // Re-populate times and re-attach event listeners
                    updateItemsList();
                } else {
                    requestsList.innerHTML = '<li style="padding:20px; text-align:center; color:#6b7280;">No matching requests</li>';
                }
            } catch (err) {
                filterError.textContent = 'Error: Failed to fetch logs';
                filterError.style.display = 'block';
            }
        }

        // Pause polling when user is typing in the search box
        search.addEventListener('focus', () => stopPolling());
        search.addEventListener('blur', () => startPolling());

        search.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                applyFilter(e.target.value);
            }, 300);
        });

        // Helper to create request item element
        function createRequestItem(log, idx) {
            const li = document.createElement('li');
            li.className = 'request-item';
            li.setAttribute('data-index', idx);
            li.setAttribute('data-requestid', log.RequestID || '');
            li.setAttribute('data-req-ts', log.Request?.timestamp || '');
            li.setAttribute('data-res-ts', log.Response?.timestamp || '');

            const method = log.Request?.method || 'OTHER';
            const path = log.Request?.path || '/';
            const status = log.Response?.status_code || 0;

            li.innerHTML = `
                <div class="summary">
                    <div class="method ${method}">${method}</div>
                    <div class="path">${escapeHtml(path)}</div>
                    <div class="status" data-status="${status}">${status === 0 ? 'Pending' : status}</div>
                </div>
                <div class="meta">
                    <div style="display:flex; gap:8px; align-items:center;">
                        <div>${log.RequestID || ''}</div>
                        <div class="item-time" style="color:#4b5563; font-family:monospace; font-size:12px; min-width:140px;">&nbsp;</div>
                    </div>
                    <div class="duration" style="font-family:monospace; color:#374151; font-size:12px;">&nbsp;</div>
                </div>
            `;

            return li;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderBody(body, contentType) {
            if (!body) {
                return '<p style="color:var(--muted)">(no body)</p>';
            }

            contentType = (contentType || '').toLowerCase();

            try {
                // Handle JSON
                if (contentType.includes('application/json') || contentType.includes('application/javascript')) {
                    try {
                        const decoded = atob(body);
                        const parsed = JSON.parse(decoded);
                        return `<pre>${escapeHtml(JSON.stringify(parsed, null, 2))}</pre>`;
                    } catch (e) {
                        // If parsing fails, show as text
                        return `<pre>${escapeHtml(atob(body))}</pre>`;
                    }
                }

                // Handle images
                if (contentType.includes('image/')) {
                    const mimeType = contentType.split(';')[0].trim();
                    return `<img src="data:${mimeType};base64,${body}" style="max-width:100%; height:auto; border-radius:6px; border:1px solid #e6edf3;" />`;
                }

                // Handle PDF
                if (contentType.includes('application/pdf')) {
                    return `<iframe src="data:application/pdf;base64,${body}" style="width:100%; height:600px; border:1px solid #e6edf3; border-radius:6px;"></iframe>`;
                }

                // Handle text-based content (CSS, JS, XML, plain text, etc.)
                if (contentType.includes('text/') ||
                    contentType.includes('application/xml') ||
                    contentType.includes('application/javascript') ||
                    contentType.includes('application/x-javascript')) {
                    return `<pre>${escapeHtml(atob(body))}</pre>`;
                }

                // For unknown binary content, show info message
                const decoded = atob(body);
                const size = new Blob([decoded]).size;
                return `<div style="padding:16px; background:#f7fafc; border-radius:6px; color:#6b7280;">
                    <p style="margin:0;">Binary content (${formatBytes(size)})</p>
                    <p style="margin:8px 0 0 0; font-size:12px;">Content-Type: ${contentType || 'unknown'}</p>
                </div>`;
            } catch (e) {
                return `<p style="color:#ef4444;">Error rendering body: ${e.message}</p>`;
            }
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function updateItemsList() {
            const items = Array.from(document.querySelectorAll('.request-item'));

            // Populate times
            items.forEach(it => {
                const reqTs = it.getAttribute('data-req-ts');
                const resTs = it.getAttribute('data-res-ts');
                const timeEl = it.querySelector('.item-time');
                const durationEl = it.querySelector('.duration');
                if (timeEl) timeEl.innerText = formatTs(reqTs);
                if (durationEl) {
                    const d = formatDuration(reqTs, resTs);
                    durationEl.innerText = (d === '—' ? (resTs && resTs != '0' ? '—' : 'Pending') : d);
                }
            });

            // Attach click handlers
            items.forEach(item => {
                item.addEventListener('click', async () => {
                    document.querySelectorAll('.request-item.selected').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');

                    const requestID = item.getAttribute('data-requestid');

                    // Show loading state
                    detailsEl.innerHTML = '<p style="color:#6b7280; padding:20px;">Loading details...</p>';
                    placeholder.style.display = 'none';

                    try {
                        // Fetch full log details
                        const response = await fetch('/api/logs/' + requestID);
                        const data = await response.json();
                        console.log({ requestID, data })

                        if (data.error || !data.log) {
                            detailsEl.innerHTML = '<p style="color:#ef4444;">Error loading log details</p>';
                            return;
                        }

                        const log = data.log;
                        const reqContentType = log.Request?.headers?.['Content-Type'] || log.Request?.headers?.['content-type'] || '';
                        const resContentType = log.Response?.headers?.['Content-Type'] || log.Response?.headers?.['content-type'] || '';

                        // Render details
                        detailsEl.innerHTML = `
                            <div class="section">
                                <h2>Request</h2>
                                <p><strong>Method:</strong> ${log.Request?.method || ''} &nbsp; <strong>Path:</strong> <code>${escapeHtml(log.Request?.path || '')}</code></p>
                                <p><strong>Time:</strong> <span class="req-ts-hr" data-ts="${log.Request?.timestamp || ''}">&nbsp;</span></p>
                                <h3>Headers</h3>
                                ${log.Request?.headers ? Object.entries(log.Request.headers).map(([k, v]) => `<div class="kv"><div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v)}</div></div>`).join('') : '<p style="color:var(--muted)">(no request headers)</p>'}
                                <h3>Body</h3>
                                ${renderBody(log.Request?.body, reqContentType)}
                            </div>
                            <div class="section">
                                <h2>Response</h2>
                                <p><strong>Status:</strong> ${log.Response?.status_code || 0}</p>
                                <p><strong>Time:</strong> <span class="res-ts-hr" data-ts="${log.Response?.timestamp || ''}">&nbsp;</span> &nbsp; <strong>Duration:</strong> <span class="duration-hr">&nbsp;</span></p>
                                <h3>Headers</h3>
                                ${log.Response?.headers ? Object.entries(log.Response.headers).map(([k, v]) => `<div class="kv"><div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v)}</div></div>`).join('') : '<p style="color:var(--muted)">(no response headers)</p>'}
                                <h3>Body</h3>
                                ${renderBody(log.Response?.body, resContentType)}
                            </div>
                        `;

                        populateDetailsTimestamps(detailsEl);

                        // make <pre> copyable on click
                        detailsEl.querySelectorAll('pre').forEach(pre => {
                            pre.title = 'Click to copy';
                            pre.style.cursor = 'pointer';
                            pre.addEventListener('click', async () => {
                                try {
                                    await navigator.clipboard.writeText(pre.innerText);
                                    pre.style.outline = '2px solid #cfe0ff';
                                    setTimeout(() => pre.style.outline = 'none', 300);
                                } catch (e) { /* ignore */ }
                            });
                        });

                        detailsEl.scrollIntoView({ behavior: 'smooth' });
                    } catch (err) {
                        detailsEl.innerHTML = '<p style="color:#ef4444;">Error fetching log details</p>';
                    }
                });

                // Apply method class normalization
                const mEl = item.querySelector('.method');
                if (mEl) {
                    const method = mEl.innerText.trim();
                    if (!['GET', 'POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
                        mEl.classList.add('OTHER');
                    }
                }
            });

            // Apply method class normalization for any unknown methods
            items.forEach(it => {
                const mEl = it.querySelector('.method');
                const method = mEl.innerText.trim();
                if (!['GET', 'POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
                    mEl.classList.add('OTHER');
                }
            });
        }
    </script>
</body>

</html>
